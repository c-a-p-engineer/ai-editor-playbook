# Docker Compose ベストプラクティス (日本語)

docker-compose.yml を作成する際のベストプラクティスをまとめました。

## 基本

- **バージョン指定**: `version` を明示的に指定することで、Compose ファイルのバージョンを固定し、予期せぬ挙動を防ぎます。最新バージョンではなく、安定版を指定することを推奨します。
- **環境変数の活用**: 環境ごとに異なる設定を環境変数で管理することで、Compose ファイルの可搬性と再利用性を高めます。`.env` ファイルや外部の環境変数設定を利用します。
- **ボリュームの明示的な定義**: データを永続化する必要がある場合は、`volumes` セクションでボリュームを明示的に定義し、サービスから参照します。名前付きボリュームを使用することで、管理が容易になります。
- **ネットワークの定義**: 複数のサービスが連携する場合は、`networks` セクションでネットワークを定義し、サービスをネットワークに参加させます。ネットワークを分離することで、セキュリティと管理性を向上させます。
- **サービス間の依存関係**: `depends_on` を使用してサービス間の起動順序を制御します。ただし、`depends_on` は起動順序のみを保証し、サービスの準備完了を待つわけではないことに注意が必要です。アプリケーション側で依存サービスの準備完了をチェックする仕組みを実装することを推奨します。
- **再起動ポリシー**: `restart` ポリシーを適切に設定することで、コンテナの異常終了時に自動的に再起動させることができます。`always`、`unless-stopped`、`on-failure` などのポリシーを検討します。
- **ロギング**: `logging` ドライバーを適切に設定し、コンテナのログを収集・管理します。fluentd、journald、gelf など、適切なロギングドライバーを選択します。
- **リソース制限**: `deploy` セクションで `resources` を設定し、コンテナが使用できる CPU やメモリリソースを制限します。リソース制限を設定することで、ホストリソースの枯渇を防ぎ、システムの安定性を向上させます。

## サービス定義ごとのベストプラクティス

- **image**: イメージは具体的なタグを指定し、`latest` タグは避ける。
- **ports**: ホストポートとコンテナポートのマッピングを明示的に記述します。不要なポート公開は避ける。
- **volumes**: ボリュームのマウントパスを明確にし、ホスト側のパスとコンテナ側のパスを対応させる。
- **environment**: 環境変数を設定ファイルから読み込むなど、管理しやすい方法で設定する。
- **build**: ビルドコンテキストを最小限に抑え、`.dockerignore` を適切に設定する。
- **networks**: サービスを参加させるネットワークを明示的に指定する。
- **depends_on**: サービスの依存関係を記述する。ただし、起動順序のみを保証することに注意。
- **restart**: サービスの再起動ポリシーを設定する。
- **logging**: サービスのロギング設定を行う。
- **deploy**: リソース制限やデプロイ戦略などを設定する (Swarm モード時)。

## その他

- **Compose ファイルの分割**: サービス数が多い場合は、Compose ファイルを複数のファイルに分割し、`docker-compose -f docker-compose.yml -f docker-compose.override.yml up` のように `-f` オプションを複数回使用して、設定を合成することを検討します。
- **命名規則**: サービス、ボリューム、ネットワークなど、Compose ファイル内で定義するリソースには一貫性のある命名規則を適用します。
- **ドキュメント**: Compose ファイルの意図や使い方を README などに記述する。
- **バージョン管理**: Compose ファイルもコードと同様にバージョン管理システムで管理する。
- **定期的なテスト**: Compose ファイルで定義した環境を定期的にテストし、問題がないことを確認します。

このドキュメントは、Docker Compose ファイル作成の出発点として活用してください。プロジェクトやアプリケーションの要件に合わせて、適宜修正・追記していくことが重要です。
