# Dockerfile ベストプラクティス (日本語)

Dockerfile を作成する際のベストプラクティスをまとめました。

## 基本

- **軽量なベースイメージを使用する**: Alpine Linux などの軽量なディストリビューションをベースイメージに選択することで、イメージサイズを削減し、セキュリティリスクを低減できます。
- **マルチステージビルド**: ビルドに必要なツールとランタイムに必要なものを分離するために、マルチステージビルドを利用します。最終的なイメージには、実行に必要な最小限のものだけを含めます。
- **キャッシュの活用**: Docker はレイヤー構造を利用してキャッシュを効率的に活用します。Dockerfile の命令の順序を最適化し、変更頻度の低い命令を ముందు に記述することで、ビルド時間を短縮できます。
- **レイヤー数の削減**: `RUN` 命令を連結したり、マルチステージビルドを利用するなどして、レイヤー数を削減します。レイヤー数が少ないほど、イメージサイズが小さくなり、パフォーマンスが向上します。
- **`.dockerignore` の活用**: 不要なファイルをイメージに含めないように、`.dockerignore` ファイルを適切に設定します。これにより、ビルド時間の短縮とイメージサイズの削減に繋がります。
- **セキュリティ**:
    - 最新のベースイメージを使用し、定期的に更新する。
    - 必要なパッケージのみをインストールする。
    - root 以外のユーザーでアプリケーションを実行する。
    - シークレット情報 (API キー、パスワードなど) をイメージに含めない。環境変数やボリュームなどを利用して外部から注入する。
- **明確なタグ付け**: イメージには意味のあるタグを付け、バージョン管理を容易にします。`latest` タグの使用は避け、具体的なバージョンやコミットハッシュなどを利用します。

## 命令ごとのベストプラクティス

- **FROM**: 具体的なバージョンを指定し、`latest` タグは避ける。
- **RUN**:
    - 複数のコマンドを `&&` で連結してレイヤー数を削減する。
    - パッケージ管理ツールのキャッシュを削除する (`apt-get clean`, `yum clean all` など)。
- **COPY / ADD**:
    - `COPY` を優先的に使用する。`ADD` は tar ファイルの展開や URL からのダウンロードなど、より高度な機能が必要な場合にのみ使用する。
    - ビルドに必要なファイルのみをコピーする。
- **WORKDIR**: 作業ディレクトリを明示的に設定する。
- **EXPOSE**: 公開するポートを記述する (必須ではないが推奨)。
- **CMD / ENTRYPOINT**:
    - イメージの主要な実行コマンドを定義する。
    - `CMD` はデフォルトの引数を提供し、`ENTRYPOINT` は常に実行されるコマンドを定義する。
- **ENV**: 環境変数を設定する。設定ファイルなどを環境変数で置き換えることで、柔軟性を高めることができる。
- **VOLUME**: 永続化が必要なデータを格納するディレクトリを定義する。

## その他

- **Dockerfile のバージョン管理**: Dockerfile もコードと同様にバージョン管理システムで管理する。
- **ドキュメント**: Dockerfile の意図や使い方を README などに記述する。
- **定期的なビルドとテスト**: イメージを定期的にビルドし、テストを行うことで、問題の早期発見に繋げる。

このドキュメントは、Dockerfile 作成の出発点として活用してください。プロジェクトやアプリケーションの要件に合わせて、適宜修正・追記していくことが重要です。
